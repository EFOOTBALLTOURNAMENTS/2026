<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
<meta name=""EFOOTBALL CHAMPIONSHIP PAKISTAN BY SANA ULLAH"" 
    content=""Join the ultimate Efootball Championship!
 View live brackets, register your team, and follow all the results for the 2025 season."">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFC BY SANA ULLAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        // Custom Tailwind config for Premier League colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pl-dark': '#37003C', // PL Primary Dark Purple (Body Background)
                        'pl-card': '#1a0d1e', // Very Dark Card Background
                        'pl-accent': '#652d91', // A medium purple for highlights
                        'pl-text': '#f4f4f4', // Off-white text
                        'pl-highlight': '#982b8b', // Vibrant pink/purple for active tabs/buttons/accents
                        'pl-header-bar': '#5b1d5c', // Header/Table Bar Gradient Look
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #982b8b; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #1a0d1e; }
 
        .tab-button {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* --- STYLES TO ENSURE ALL HEADERS ARE WHITE --- */
        .tab-pane h2, .tab-pane h3, .tab-pane h4 {
            /* This ensures any text inside the headers remains white for contrast */
            color: white !important;
        }

        /* --- NEW STYLES FOR MAIN HEADER BACKGROUND --- */
        .custom-header-bg {
            background-image: url('https://i.postimg.cc/zGKLCjcD/Screenshot-20251110-193550-2.jpg'); 
            background-size: cover;
            background-position: center;
            background-color: #37003C; /* Fallback */
            border-bottom: 2px solid #982b8b;
        }
        
        /* --- NEW CLASS FOR SECTION HEADERS (H2, H3, H4) --- */
        .section-header-bg {
            background-image: url('https://i.postimg.cc/zGKLCjcD/Screenshot-20251110-193550-2.jpg'); 
            background-size: cover;
            background-position: center;
            background-color: #37003C; /* Fallback */
            border-bottom: 2px solid #982b8b;
        }


        /* --- SPLASH SCREEN STYLE --- */
        .el-clasico-bg {
            /* IMPORTANT: THIS IS THE BANNER IMAGE FROM THE PREVIOUS REQUEST */
            background-image: url('https://i.postimg.cc/6qGS3F6v/images-3-1.jpg');
            background-size: cover;
            background-position: center;
        }
        .el-clasico-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: -1;
        }
    </style>
</head>
<body class="bg-pl-dark min-h-screen text-pl-text">

    <div id="splash-screen" class="fixed inset-0 el-clasico-bg flex items-center justify-center z-[100] transition-opacity duration-1000">
        <div class="text-center p-8 rounded-xl bg-black bg-opacity-70 shadow-2xl relative z-10">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/f/f2/Premier_League_Logo.svg/100px-Premier_League_Logo.svg.png" 
                 alt="Premier League Logo" 
                 class="w-20 h-20 mx-auto text-pl-highlight animate-pulse filter drop-shadow-lg"
                 style="filter: invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%);">
            
            <h1 class="text-6xl font-black text-white mt-4 tracking-widest">EFOOTBALL</h1>
            <h2 class="text-2xl font-semibold text-pl-highlight mt-2">CHAMPIONSHIP PAKISTAN</h2>
            <p 
 class="text-md text-gray-300 mt-6">ORGANIZED BY SANA ULLAH</p>
        </div>
    </div>

    <div id="main-app" class="hidden max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="flex flex-col sm:flex-row justify-between items-center custom-header-bg p-4 rounded-xl shadow-lg mb-6 sticky top-4 z-40 text-white">
            <h1 class="text-2xl sm:text-3xl font-bold flex items-center">
                <img src="https://upload.wikimedia.org/wikipedia/en/thumb/f/f2/Premier_League_Logo.svg/100px-Premier_League_Logo.svg.png" 
                     alt="PL Logo" 
                     class="w-8 h-8 mr-2 filter drop-shadow-lg"
                     style="filter: invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%);">

                <span>EFC BY SANA ULLAH</span>
            </h1>
            <div id="auth-status" class="text-sm mt-2 sm:mt-0 text-pl-text flex items-center">
                <i id="user-icon" class="ph-bold ph-user-circle text-xl mr-1 text-pl-text"></i>
                <span id="user-display">Guest</span>
        
  </div>
        </header>

        <nav class="bg-pl-header-bar p-1 rounded-xl shadow-md mb-6 sticky top-[80px] z-30">
            <div class="flex flex-wrap justify-around text-center">
                <div data-tab="admin" class="tab-button flex-1 py-3 px-2 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent">
                    <i class="ph-bold ph-lock mr-1"></i> ADMIN
   
          </div>
                <div data-tab="fixtures" class="tab-button flex-1 py-3 px-2 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent">
                    <i class="ph-bold ph-calendar-blank mr-1"></i> FIXTURES
                </div>
                <div 
 data-tab="points" class="tab-button flex-1 py-3 px-2 
 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent">
                    <i class="ph-bold ph-table mr-1"></i> POINTS TABLE
                </div>
                <div data-tab="stats" class="tab-button flex-1 py-3 px-2 rounded-lg text-white font-semibold text-sm sm:text-base border-2 border-transparent">
                    <i class="ph-bold ph-chart-bar 
 mr-1"></i> STATS
     
             </div>
            </div>
        </nav>

        <div id="tab-content" class="space-y-6">

            <div id="admin" class="tab-pane space-y-6 hidden">
                <div id="admin-auth-panel" class="bg-pl-card p-6 rounded-xl shadow-md">
              
       <h2 class="text-2xl font-semibold text-white section-header-bg p-3 rounded-lg flex items-center mb-4">
                        <i class="ph-bold ph-lock-key text-2xl mr-2 text-pl-highlight"></i> Admin Access
                    </h2>
                    <form id="admin-auth-form" class="space-y-3">
            
    <input type="password" id="admin-password" placeholder="Enter Admin Password" required
                            class="block w-full rounded-md border-pl-highlight/50 shadow-sm p-3 border focus:border-pl-highlight focus:ring-pl-highlight bg-pl-dark text-pl-text">
                        <button type="submit"
                    
         class="w-full px-4 
 py-2 bg-pl-highlight text-white font-semibold rounded-lg shadow-md hover:bg-pl-highlight/80 transition duration-150">
                            Unlock Admin Panel
                        </button>
                        <div id="admin-auth-message" class="text-sm 
 mt-2 text-center text-pl-highlight"></div>
         
            </form>
                </div>

                <div id="admin-panel" class="space-y-6 hidden">
                    
                    <div class="bg-pl-card 
 p-6 rounded-xl shadow-md">
          
               <h3 class="text-xl font-bold text-white section-header-bg p-3 rounded-lg flex items-center mb-4">
                            <i class="ph-bold ph-calendar-check mr-2 text-pl-highlight"></i> Organize Ongoing Tournaments
                        </h3>
       
     <div id="current-tournament-status" class="space-y-4">
                            <div class="text-center py-6 text-pl-text">Loading tournament status...</div>
                        </div>
                    </div>


   
    <div class="bg-pl-card p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold text-white section-header-bg p-3 rounded-lg mb-4">Start New Tournament</h3>
                        <form id="start-tournament-form" class="space-y-4">
                    
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
   
                              <div>
                                    <label class="block text-sm font-medium text-pl-text">Matches Per Team</label>
             
        <input type="number" id="num-rounds" required value="2" min="1"
                                        class="mt-1 block w-full rounded-md border-pl-highlight/50 shadow-sm p-3 border focus:border-pl-highlight focus:ring-pl-highlight bg-pl-dark text-pl-text">
                      
               <p class="text-xs text-gray-400 
 mt-1">Total rounds will be (Teams - 1) * N</p>
                                </div>
                                <div>
          
         <label class="block text-sm font-medium text-pl-text">Teams Count (Even, min 4)</label>
                                    <input type="number" id="teams-count" required value="16" min="4" step="2"
                       
                  class="mt-1 block 
 w-full rounded-md border-pl-highlight/50 shadow-sm p-3 border focus:border-pl-highlight focus:ring-pl-highlight bg-pl-dark text-pl-text">
                                </div>
                                <div>
         
                     
        <label class="block text-sm font-medium text-pl-text">Tournament Start Date</label>
                                    <input type="date" id="start-date" required
                           
              class="mt-1 block w-full rounded-md border-pl-highlight/50 shadow-sm p-3 border 
 focus:border-pl-highlight focus:ring-pl-highlight bg-pl-dark text-pl-text">
                                </div>
                                <div>
             
                       
  <label class="block text-sm font-medium text-pl-text">Matches Per Team Per Day</label>
                                    <input type="number" id="matches-per-day" required value="1" min="1"
                           
              class="mt-1 block w-full rounded-md border-pl-highlight/50 shadow-sm p-3 border focus:border-pl-highlight focus:ring-pl-highlight bg-pl-dark text-pl-text">
     
                                </div>
                            </div>

             
                <label class="block text-sm font-medium text-pl-text pt-2">Team & Player Assignment (Team name : Player Name)</label>
    
                         <textarea id="teams-and-players" rows="16" required
                                class="mt-1 block w-full rounded-md border-pl-highlight/50 shadow-sm p-3 border 
focus:border-pl-highlight focus:ring-pl-highlight bg-pl-dark text-pl-text">
Manchester United : @~Sonofsardar
Manchester City : @~Sayed Maroof Shah
Liverpool : @~Asad Ullah
Chelsea : @~Abdul Hamid Thoba
Tottenham Hotspur : @~An
Arsenal : @~Hassan Ahad
Fulham : @‚Å®~SwordFish‚Å©
Nottingham Forest : Muazamüòí
AFC Bournemouth : @‚Å®~Muhammad Yousuf‚Å©
Crystal Palace : @‚Å®CADET SYED üòé‚Å©
Wolverhampton Wanderers : @~Muhammad Amjad
Sunderland : @sanaullah
Newcastle United : @~sana khan
Brighton & Hove Albion : @~Imadkhan
Aston Villa : @~SIKANDAR SHAMS
Brentford : @asim
</textarea>
                            <p class="text-xs text-gray-400">Ensure the number of lines matches 
 the Teams Count above.</p>

                            <button type="submit"
  
                               class="w-full px-4 py-3 bg-pl-highlight text-white font-semibold rounded-lg shadow-md hover:bg-pl-highlight/80 transition duration-150 flex items-center justify-center">
                      
           <i class="ph-bold ph-calendar-plus text-xl mr-2"></i> GENERATE FIXTURES & START
                 
            </button>
                            <div id="start-message" class="text-sm mt-2 text-center text-pl-highlight"></div>
                    
     </form>
                    </div>

            
         <div class="bg-pl-card p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold text-white section-header-bg p-3 rounded-lg mb-4">Upload Match Results</h3>
                   
         <div id="admin-results-content">
                            <div class="text-center py-6 
 text-pl-text">
                                Select an active tournament above to load results panel.
 </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="fixtures" class="tab-pane space-y-6">
             
    <div class="bg-pl-card p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold text-white section-header-bg p-3 rounded-lg flex items-center mb-4">
                        <i class="ph-bold ph-calendar-check text-2xl mr-2 text-pl-highlight"></i> Ongoing Matchday Fixtures
                    </h2>
            
        <div id="fixtures-content">
                        <div class="text-center py-6 text-pl-text">
                            Tournament fixtures will appear here once the schedule is generated.
 </div>
                    </div>
                </div>
            </div>

            <div id="points" class="tab-pane space-y-6 hidden">
                <div class="bg-pl-card p-6 rounded-xl shadow-md">
                
     <h2 class="text-2xl font-semibold text-white section-header-bg p-3 rounded-lg flex items-center mb-4">
                        <i class="ph-bold ph-list-numbers text-2xl mr-2 text-pl-highlight"></i> Official Points Table
                    </h2>
                    <div id="points-table-content" class="overflow-x-auto">
             
           <div class="text-center py-6 text-pl-text">
                            Upload results in the Admin tab to populate the points table.
 </div>
                    </div>
                </div>
            </div>

            <div id="stats" class="tab-pane space-y-6 hidden">
                <div class="bg-pl-card p-6 rounded-xl shadow-md">
                
     <h2 class="text-2xl font-semibold text-white section-header-bg p-3 rounded-lg flex items-center mb-4">
                        <i class="ph-bold ph-chart-line text-2xl mr-2 text-pl-highlight"></i> League Statistics
                    </h2>
                    <div id="stats-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
           
             <div id="top-scorers" class="bg-pl-dark p-4 rounded-lg shadow-inner">
                            <h4 class="font-bold text-white section-header-bg p-2 rounded-lg mb-3">Top Goalscorers (GF)</h4>
                            <ul id="scorers-list" class="space-y-1 text-pl-text"></ul>
               
        </div>
                        <div id="top-defense" class="bg-pl-dark p-4 rounded-lg shadow-inner">
                            <h4 class="font-bold text-white section-header-bg p-2 rounded-lg mb-3">Best Defense (GA)</h4>
                          
   <ul 
 id="defense-list" class="space-y-1 text-pl-text"></ul>
                        </div>
                    </div>
                    <div id="stats-misc" class="text-center pt-6 text-sm text-pl-text/70"></div>
                </div>
         
    </div>
 
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // --- CONSTANTS & FIREBASE SETUP ---
        const ADMIN_PASSWORD = "EFOOTBALL2026";
        // YOUR EMBEDDED FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyAKXE_sklR_wpRYUaV-l7jZFHbEOhN0GZU",
            authDomain: "efootball-2026.firebaseapp.com",
            databaseURL: "https://efootball-2026-default-rtdb.firebaseio.com",
            projectId: "efootball-2026",
            storageBucket: "efootball-2026.firebasestorage.app",
            messagingSenderId: "189433778137",
       
      appId: "1:189433778137:web:10517370da0990108d93c8",
            measurementId: "G-3ZQ3KGXPFG"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const tournamentRef = database.ref('tournament/settings');

        let isAdmin = false; 
        let currentTab = 'fixtures';
        let tournamentData = null; // Stores latest tournament data

        // --- TEAM LOGO MAPPING (Updated to include Sunderland and match player list) ---
        const TEAM_LOGOS = {
            'Manchester United': 'https://crests.football-data.org/66.png',
            'Manchester City': 'https://crests.football-data.org/65.png',
            'Liverpool': 'https://crests.football-data.org/67.png',
            'Chelsea': 'https://crests.football-data.org/61.png',
            'Tottenham Hotspur': 'https://crests.football-data.org/73.png',
            'Arsenal': 'https://crests.football-data.org/57.png',
            'Fulham': 'https://crests.football-data.org/63.png',
            'Nottingham Forest': 'https://crests.football-data.org/351.png',
            'AFC Bournemouth': 'https://crests.football-data.org/1044.png',
            'Crystal Palace': 'https://crests.football-data.org/341.png',
            'Wolverhampton Wanderers': 'https://crests.football-data.org/76.png',
            'Sunderland': 'https://crests.football-data.org/394.png', // New Team Crest
            'Newcastle United': 'https://crests.football-data.org/62.png',
            'Brighton & Hove Albion': 'https://crests.football-data.org/397.png',
            'Aston Villa': 'https://crests.football-data.org/58.png',
            'Brentford': 'https://crests.football-data.org/404.png',
        };

        const getTeamLogoHtml = (teamName, sizeClass = 'w-5 h-5') => {
            const logoUrl = TEAM_LOGOS[teamName];
            if (logoUrl) {
                return `<img src="${logoUrl}" alt="${teamName} Logo" class="${sizeClass} object-contain mr-2">`;
            }
            return '';
        }
        
        // --- UTILITY FUNCTIONS ---

        const showMessage = (elementId, message, isError = true) => {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = message;
            el.className = `text-sm mt-2 text-center ${isError ? 'text-pl-highlight' : 'text-green-500'}`;
            setTimeout(() => el.textContent = '', 5000);
        };
        
        const getDatesBetween = (start, end) => {
            const dates = [];
            let currentDate = new Date(start);
            const endDate = new Date(end);
            // Ensure start date is valid
            if (isNaN(currentDate.getTime()) || isNaN(endDate.getTime())) return dates;
            while (currentDate <= endDate) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        };
        // --- APP INITIALIZATION ---

        const initializeApp = () => {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            // Removed: Setting default end date
            
            // Set default teams count and matches per day
            document.getElementById('teams-count').value = 16;
            document.getElementById('matches-per-day').value = 1;

            // Setup Event Listeners
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
            });
            document.getElementById('admin-auth-form').addEventListener('submit', handleAdminAuth);
            document.getElementById('start-tournament-form').addEventListener('submit', handleStartTournament);

            // Hide splash screen and show main app after a delay (6000ms = 6 seconds)
            setTimeout(() => {
                document.getElementById('splash-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash-screen').classList.add('hidden');
            
         document.getElementById('main-app').classList.remove('hidden');
                }, 1000);
            }, 6000);
            // 6 seconds delay
            
            // Ensure the initial tab (fixtures) is correctly activated on load
            switchTab(currentTab);
        };
        // --- TAB NAVIGATION ---

        const switchTab = (tabName) => {
            currentTab = tabName;
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                const isSelected = btn.getAttribute('data-tab') === tabName;
                
                // Reset classes
        
         btn.classList.remove('bg-pl-accent', 'border-pl-highlight', 'text-pl-highlight', 'text-white', 'border-transparent');
                btn.classList.add('border-2');

                if (isSelected) {
                    // Active tab: Set accent background, highlight border, and white text
                    btn.classList.add('bg-pl-accent', 'text-white', 'border-pl-highlight');
                } else {
                 
                  // Inactive tab: Set transparent border and **PERMANENTLY WHITE TEXT**
                  btn.classList.add('border-transparent', 'text-white'); 
                }
            });
            // Update content panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.toggle('hidden', pane.id !== tabName);
            });
            // Re-render admin results and management if switching to admin
            if (tabName === 'admin' && isAdmin) {
                renderAdminManagementPanel(tournamentData);
                // Rerender management panel
                renderAdminResultsContent(tournamentData);
                // Rerender results panel
            }
            
            // Re-render stats if switching to stats
            if (tabName === 'stats' && tournamentData) {
                const standings = calculateStandings(tournamentData.teams, tournamentData.schedule);
                renderStats(standings, tournamentData.players);
            }
        };
        // --- ADMIN AUTHENTICATION ---

        const handleAdminAuth = (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('admin-auth-panel').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('user-icon').classList.replace('text-pl-text', 'text-pl-highlight');
                document.getElementById('user-display').textContent = `Admin User`;
                showMessage('admin-auth-message', 'Admin access granted!', false);
                // Call render functions immediately after login
                renderAdminManagementPanel(tournamentData);
                renderAdminResultsContent(tournamentData);
            } else {
                isAdmin = false;
                showMessage('admin-auth-message', 'Incorrect password. Access denied.', true);
            }
        };
        // --- TOURNAMENT SCHEDULE GENERATION (Standard Round Robin) ---

        const generateRoundRobin = (teamNames, numRounds, startDateStr, matchesPerTeamPerDay) => {
            let n = teamNames.length;
            if (n % 2 !== 0) n++;
            let teams = [...teamNames];
            while (teams.length < n) { teams.push('BYE');
            } // Pad with BYE if odd

            const schedule = [];
            const totalRoundRobinRounds = n - 1;
            const totalLeagueRounds = totalRoundRobinRounds * numRounds;
            const half = n / 2;
            // New logic for Matchday assignment
            const matchesPerRoundDay = Math.floor(n / 2) * matchesPerTeamPerDay;
            // Total matches played by players in one day
            let currentMatchDay = new Date(startDateStr);
            let matchesOnCurrentDay = 0;
            let leagueRoundNumber = 0;
            
            for (let r = 1; r <= numRounds; r++) {
                // Determine if we should flip the home/away teams for this round block
                const isFlippedRoundBlock = r % 2 === 0;
                let currentTeams = [...teams];
                
                for (let round = 1; round <= totalRoundRobinRounds; round++) {
                    leagueRoundNumber++;
                    const roundMatches = [];
                    
                    for (let i = 0; i < half; i++) {
                        const home = currentTeams[i];
                        const away = currentTeams[i + half];

                        if (home !== 'BYE' && away !== 'BYE') {
                            
                            // Combine flipping: flip if r is even.
                            const [team1, team2] = isFlippedRoundBlock ? [away, home] : [home, away];
                            roundMatches.push({
                                id: `${leagueRoundNumber}-${roundMatches.length}`, // Use index as part of ID for uniqueness
                                home: team1,
                         
                                away: team2,
 
                                homeScore: null,
                                awayScore: null,
                         
                            });
                        }
                    }

                    // Assign date based on matchesPerRoundDay
                    let dateToAssign = currentMatchDay.toISOString().split('T')[0];
                    matchesOnCurrentDay += roundMatches.length;

                    // If adding these matches exceeds the limit, move to the next day
                    if (matchesOnCurrentDay > matchesPerRoundDay) {
                        currentMatchDay.setDate(currentMatchDay.getDate() + 1);
                        dateToAssign = currentMatchDay.toISOString().split('T')[0];
                        matchesOnCurrentDay = roundMatches.length; // Start count for the new day
                    }

                    schedule.push({ 
                        round: leagueRoundNumber, 
                     
                        date: dateToAssign, // Assigned date
                        matches: roundMatches 
 
                    });
                    // Rotate teams (Fixed team[0], rotate the rest)
                    if (currentTeams.length > 2) {
                        const fixedTeam = currentTeams[0];
                        const last = currentTeams.pop();
                        currentTeams.splice(1, 0, last);
                        currentTeams[0] = fixedTeam;
                        // Keep the first team fixed after rotation
                    }
                }
            }
            return schedule;
        };
        
        const handleStartTournament = async (e) => {
            e.preventDefault();
            if (!isAdmin) { showMessage('start-message', 'Admin privileges required.', true); return; }

            const teamsCount = parseInt(document.getElementById('teams-count').value);
            const numRounds = parseInt(document.getElementById('num-rounds').value);
            const startDateStr = document.getElementById('start-date').value;
            // NEW INPUT
            const matchesPerTeamPerDay = parseInt(document.getElementById('matches-per-day').value);
            // Removed: endDateStr
            const playerInput = document.getElementById('teams-and-players').value.trim().split('\n');
            const teams = [];
            const players = {};
            playerInput.forEach(line => {
                const [team, player] = line.split(':').map(s => s.trim());
                if (team && player) {
                    teams.push(team);
                    players[team] = player;
      
         }
            });
            if (teams.length !== teamsCount || teamsCount < 4 || teamsCount % 2 !== 0) {
                showMessage('start-message', 'Teams count must be even (min 4) and match the input list size.', true);
                return;
            }
            
            // PASS NEW PARAMETER
            const schedule = generateRoundRobin(teams, numRounds, startDateStr, matchesPerTeamPerDay);
            const tournamentDataToSave = {
                teams: teams,
                players: players,
                numRoundsPerTeam: numRounds,
                startDate: startDateStr,
                // NEW DATA FIELD
          
                matchesPerTeamPerDay: matchesPerTeamPerDay,
                // Removed: endDateStr
            
                schedule: schedule, // Save as object/array for Realtime DB
                organizerId: "ADMIN_USER", // Simple placeholder
                lastUpdated: new Date().toISOString()
            
            };
            try {
                // Realtime Database 'set' function
                await tournamentRef.set(tournamentDataToSave);
                showMessage('start-message', `Tournament started with ${schedule.length} matchdays!`, false);
                switchTab('fixtures'); // Move to fixtures tab after creation
            } catch (error) {
                console.error("Error saving tournament data:", error);
                showMessage('start-message', 'Failed to save tournament data. Check console.', true);
            }
        };
        // --- TOURNAMENT DELETION LOGIC ---
        const handleDeleteTournament = async () => {
             if (!isAdmin) return;
            const confirmation = confirm("Are you sure you want to delete the entire tournament and all results? This action cannot be undone.");
            if (confirmation) {
                 try {
                     await tournamentRef.remove();
                    // Data will be reset via the listener
                     showMessage('current-tournament-status', 'Tournament successfully deleted!', false);
                 } catch (error) {
                     console.error("Error deleting tournament:", error);
                     showMessage('current-tournament-status', 'Failed to delete tournament. Check console.', true);
                 }
             }
        }


        // --- RESULTS UPLOAD LOGIC ---

        const handleResultUpdate = async (e) => {
            e.preventDefault();
            if (!isAdmin || !tournamentData) return;

            const form = e.currentTarget;
            const matchId = form.getAttribute('data-match-id');
            const homeScore = parseInt(form.querySelector('.score-input-home').value);
            const awayScore = parseInt(form.querySelector('.score-input-away').value);

            if (isNaN(homeScore) || isNaN(awayScore)) {
                alert('Scores must be valid numbers.');
                return;
            }
            
            try {
                // Find and update the match in the local copy of the schedule
                let found = false;
                const newSchedule = tournamentData.schedule.map(round => ({
                    ...round,
                    matches: round.matches.map(match => {
                        if (match.id === matchId) {
                        
     match.homeScore = homeScore;
                            match.awayScore = awayScore;
                            found = true;
                        }
         
               return match;
                    })
                }));
                if (found) {
                    // Update the entire 'schedule' node in the database
                    await tournamentRef.update({
                        schedule: newSchedule,
                        
                        lastUpdated: new Date().toISOString()
                    });
                    // Small visual feedback on the button
                    const btn = form.querySelector('button[type="submit"]');
                    btn.innerHTML = `<i class="ph-bold ph-check text-lg"></i>`;
                    btn.classList.replace('bg-pl-highlight', 'bg-green-600');
                    setTimeout(() => {
                        btn.innerHTML = `<i class="ph-bold ph-floppy-disk text-lg"></i>`;
                        btn.classList.replace('bg-green-600', 'bg-pl-highlight');
                    }, 1000);
                } else {
                    throw "Match ID not found in schedule.";
                }
            } catch (error) {
                console.error("Failed to update match result:", error);
                alert('Failed to save result. Check console.');
            }
        };
        // --- STANDINGS & STATS CALCULATIONS ---

        const calculateStandings = (teams, scheduleData) => {
            const standings = {};
            teams.forEach(team => {
                standings[team] = {
                    team: team, P: 0, W: 0, D: 0, L: 0, GF: 0, GA: 0, GD: 0, Pts: 0
                };
            });
            if (!scheduleData) return [];

            scheduleData.forEach(round => {
                round.matches.forEach(match => {
                    const homeTeam = match.home;
                    const awayTeam = match.away;
                    const homeScore = parseInt(match.homeScore);
       
              const awayScore = parseInt(match.awayScore);

                    if (isNaN(homeScore) || isNaN(awayScore) || !standings[homeTeam] || !standings[awayTeam]) return;

                    const home = standings[homeTeam];
                    const away = standings[awayTeam];
         
           
                    // Games Played (P)
                    home.P++; away.P++;

                    // Goals For/Against
                    home.GF += 
 homeScore; home.GA 
 += awayScore;
                    away.GF += awayScore; away.GA += homeScore;

                    // Results and Points
                    if (homeScore > awayScore) {
                        
                        home.W++; home.Pts += 
 3; away.L++;
                    } else if (homeScore < awayScore) {
                        away.W++;
                        away.Pts += 3; home.L++;
                    } else {
                        home.D++;
                        home.Pts += 1; away.D++; away.Pts += 1;
                    }
                });
            });

            // Calculate Goal Difference (GD)
            Object.values(standings).forEach(team => {
                team.GD = team.GF - team.GA;
            });
            // Sort by Pts (desc), then GD (desc), then GF (desc)
            return Object.values(standings).sort((a, b) => 
                b.Pts - a.Pts || b.GD - a.GD || b.GF - a.GF
            );
        };
        
        // --- RENDERING FUNCTIONS ---
        
        const renderAdminManagementPanel = (tournament) => {
             const container = document.getElementById('current-tournament-status');
            if (!tournament) {
                 container.innerHTML = `
                     <div class="p-4 bg-pl-card border-l-4 border-pl-highlight text-pl-text">
                         <p class="font-bold">No Active Tournament</p>
                         
 <p class="text-sm">Use the 'Start New Tournament' section below to create a schedule.</p>
                     </div>
                 `;
                // Also ensure the results content is reset if no tournament is active
                 document.getElementById('admin-results-content').innerHTML = '<div class="text-center py-6 text-pl-text">Generate a schedule above to start uploading results.</div>';
                return;
             }
             
             const standings = calculateStandings(tournament.teams, tournament.schedule);
            const matchesPlayed = standings.reduce((sum, t) => sum + t.P, 0) / 2;
            const totalMatches = tournament.schedule.reduce((sum, r) => sum + r.matches.length, 0);
            const progress = totalMatches > 0 ?
            ((matchesPlayed / totalMatches) * 100).toFixed(0) : 0;
            const firstPlace = standings.length > 0 ? standings[0].team : 'N/A';
            // Calculate Estimated End Date
            const uniqueDates = [...new Set(tournament.schedule.map(r => r.date))];
            const estimatedEndDate = uniqueDates.length > 0 ? uniqueDates[uniqueDates.length - 1] : 'N/A';
            container.innerHTML = `
                 <div class="bg-pl-dark p-4 rounded-lg border-2 border-pl-highlight/50">
                     <p class="font-bold text-pl-highlight flex items-center mb-2">
                        <i class="ph-bold ph-calendar-check text-xl mr-2"></i> Active Tournament (EFOOTBALL 2026)
                  
     </p>
                     <div class="grid grid-cols-2 gap-2 text-sm text-pl-text">
                         <p><strong>Teams:</strong> ${tournament.teams.length}</p>
                         <p><strong>Rounds:</strong> ${tournament.numRoundsPerTeam}</p>
                 
       <p><strong>Matches:</strong> ${matchesPlayed} / ${totalMatches}</p>
                         <p><strong>Leader:</strong> ${firstPlace}</p>
                         <p><strong>Start Date:</strong> ${tournament.startDate}</p>
                         <p><strong>Est.
 End Date:</strong> ${estimatedEndDate}</p>
                         <p class="col-span-2"><strong>Matches/Day/Team:</strong> ${tournament.matchesPerTeamPerDay}</p>
                     </div>
               
       <div class="w-full bg-pl-card rounded-full h-2.5 mt-3">
                       
 <div class="bg-pl-highlight h-2.5 rounded-full" style="width: ${progress}%"></div>
                     </div>
                     <p class="text-xs text-pl-text/70 text-center mt-1">${progress}% Complete</p>
             
     </div>
                 <div class="flex justify-center mt-4">
         
            <button id="delete-tournament-btn" 
                        class="px-4 py-2 bg-pl-highlight text-white font-semibold rounded-lg shadow-md hover:bg-pl-highlight/80 transition duration-150 flex items-center">
                  
       <i class="ph-bold ph-trash-simple text-lg mr-2"></i> Delete Tournament
                    
 </button>
                 </div>
             `;
            document.getElementById('delete-tournament-btn').addEventListener('click', handleDeleteTournament);
             
             // After rendering the management panel, ensure the results panel is loaded too
             renderAdminResultsContent(tournament);
        }

        const renderAdminResultsContent = (tournament) => {
            const container = document.getElementById('admin-results-content');
            if (!isAdmin || !tournament || !tournament.schedule) {
                 container.innerHTML = '<div class="text-center py-6 text-pl-text">Generate a schedule above to start uploading results.</div>';
                return;
            }

            const scheduleData = tournament.schedule;
            let html = '';

            scheduleData.forEach(round => {
                html += `
                    <div class="bg-pl-dark p-3 rounded-lg mt-4 shadow-inner">
                        <h4 class="text-md font-bold text-pl-highlight mb-3">Matchday ${round.round} (${round.date})</h4>
                     
    <div class="space-y-2">
                `;
                round.matches.forEach(match => {
                    const homeScore = match.homeScore === null ? '' : match.homeScore;
                    const awayScore = match.awayScore === null ? '' : match.awayScore;
   
                 
                    html += `
                        <form data-match-id="${match.id}" class="match-update-form flex items-center space-x-2 bg-pl-card p-2 rounded-md border border-pl-highlight/30">
                          
 <div class="font-semibold text-pl-text w-1/3 truncate">${match.home}</div>
                            <input type="number" min="0" value="${homeScore}" placeholder="0" class="w-12 p-1 text-center border rounded score-input-home focus:border-pl-highlight bg-pl-dark text-pl-text">
                            <span class="font-bold text-pl-highlight">-</span>
                        
    
  <input type="number" min="0" value="${awayScore}" placeholder="0" class="w-12 p-1 text-center border rounded score-input-away focus:border-pl-highlight bg-pl-dark text-pl-text">
                            <div class="font-semibold text-pl-text w-1/3 text-right truncate">${match.away}</div>
                            <button type="submit" class="p-1 bg-pl-highlight text-white rounded-md text-sm hover:bg-pl-highlight/80 transition" title="Save Score">
             
     
               <i class="ph-bold ph-floppy-disk text-lg"></i>
                            </button>
                        </form>
                    `;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;
            container.querySelectorAll('.match-update-form').forEach(form => {
                form.addEventListener('submit', handleResultUpdate);
            });
        };

        const renderFixtures = (tournament) => {
            const container = document.getElementById('fixtures-content');
            if (!tournament || !tournament.schedule || tournament.schedule.length === 0) {
                container.innerHTML = '<div class="text-center py-6 text-pl-text">Tournament fixtures will appear here once the schedule is generated.</div>';
                return;
            }
            
            const scheduleData = tournament.schedule;
            let html = '';
            
            scheduleData.forEach(round => {
                html += `
                    <div class="bg-pl-dark p-4 rounded-lg mt-4 shadow-inner">
                        <h4 class="text-lg font-bold text-pl-highlight mb-3">Matchday ${round.round} (${round.date})</h4>
                     
    <div class="space-y-2">
                `;
                round.matches.forEach(match => {
                    const scoreDisplay = match.homeScore !== null ? 
                        `<span class="font-bold text-white">${match.homeScore} - ${match.awayScore}</span>` : 
     
                      '<span class="text-pl-text/50 italic">vs</span>';

                    const homeLogo = getTeamLogoHtml(match.home, 'w-6 h-6');
                    const awayLogo = getTeamLogoHtml(match.away, 'w-6 h-6');
                        
                    html += `
                        <div class="flex justify-between items-center bg-pl-card 
 p-3 rounded-md shadow-sm border border-pl-highlight/30">
 
                            <div class="font-semibold text-pl-text w-1/3 flex items-center truncate">${homeLogo} ${match.home}</div>
                            <div class="w-1/3 text-center">${scoreDisplay}</div>
                            <div class="font-semibold text-pl-text w-1/3 text-right 
 flex items-center justify-end truncate">${match.away} ${awayLogo}</div>
      
                   </div>
                    `;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;
        };

        const renderPointsTable = (standings, players) => {
            const container = document.getElementById('points-table-content');
            if (standings.length === 0) {
                container.innerHTML = '<div class="text-center py-6 text-pl-text">Upload results in the Admin tab to populate the points table.</div>';
                return;
            }
            
            const header = `
                <table class="min-w-full divide-y divide-pl-highlight/30 shadow overflow-hidden sm:rounded-lg">
                    <thead class="bg-pl-highlight text-white">
                        <tr>
    
                         <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Team (Player)</th>
                            <th class="px-3 py-3 text-center 
 text-xs 
 font-medium uppercase tracking-wider">P</th>
                            <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider hidden sm:table-cell">W</th>
                            <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider hidden sm:table-cell">D</th>
                      
     <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider hidden sm:table-cell">L</th>
                            <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider hidden md:table-cell">GF</th>
                            <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider hidden md:table-cell">GA</th>
          
                <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider">GD</th>
                            <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider">Pts</th>
                        </tr>
               
  </thead>
                    <tbody class="bg-pl-card divide-y divide-pl-highlight/30" id="table-body">
            `;
            let rows = '';
            standings.forEach((team, index) => {
                const rankClass = index < 4 ? 'bg-pl-dark font-bold border-l-4 border-pl-highlight' : 'bg-pl-card'; // Top 4 highlight
                const playerName = players[team.team] || 'N/A';
                const teamLogo = getTeamLogoHtml(team.team);
                rows += `
                    <tr class="${rankClass}">
       
                  <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-pl-text text-center">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-pl-text flex items-center">
                            ${teamLogo} ${team.team} <span class="text-pl-text/50 text-xs ml-2 block sm:inline">(${playerName})</span>
           
             </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center">${team.P}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center hidden sm:table-cell">${team.W}</td>
                        <td class="px-3 
 py-4 whitespace-nowrap 
 text-sm text-center hidden sm:table-cell">${team.D}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center hidden sm:table-cell">${team.L}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center hidden md:table-cell">${team.GF}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center hidden md:table-cell">${team.GA}</td>
 
    
                      <td class="px-3 py-4 whitespace-nowrap text-sm text-center font-bold text-pl-highlight">${team.GD > 0 ?
 '+' : ''}${team.GD}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center font-extrabold text-pl-highlight">${team.Pts}</td>
                    </tr>
                `;
            });

            container.innerHTML = header + rows + '</tbody></table>';
        };

        const renderStats = (standings, players) => {
            const scorersList = document.getElementById('scorers-list');
            const defenseList = document.getElementById('defense-list');
            const statsMisc = document.getElementById('stats-misc');
            
            if (standings.length === 0) {
                scorersList.innerHTML = '<li>No stats available yet.</li>';
                defenseList.innerHTML = '<li>No stats available yet.</li>';
                statsMisc.textContent = 'Data will populate after match results are entered.';
                return;
            }

            // Top Scorers (Sort by GF desc)
            const topScorers = [...standings].sort((a, b) => b.GF - a.GF).slice(0, 5);
            scorersList.innerHTML = topScorers.map(team => {
                const playerName = players[team.team] || 'N/A';
                const teamLogo = getTeamLogoHtml(team.team, 'w-4 h-4');
                return `<li class="flex justify-between items-center">
                            <span class="flex items-center">${teamLogo} ${team.team} (${playerName})</span>
                           
  <span class="font-bold text-pl-highlight">${team.GF}</span>
                        </li>`;
            }).join('');
            // Best Defense (Sort by GA asc)
            const bestDefense = [...standings].sort((a, b) => a.GA - b.GA).slice(0, 5);
            defenseList.innerHTML = bestDefense.map(team => {
                const playerName = players[team.team] || 'N/A';
                const teamLogo = getTeamLogoHtml(team.team, 'w-4 h-4');
                return `<li class="flex justify-between items-center">
                            <span class="flex items-center">${teamLogo} ${team.team} (${playerName})</span>
                           
  <span class="font-bold text-pl-highlight">${team.GA}</span>
                        </li>`;
            }).join('');
            // Misc Stats
            const totalMatches = standings.reduce((sum, t) => sum + t.P, 0) / 2;
            const totalGoals = standings.reduce((sum, t) => sum + t.GF, 0);
            const avgGoals = totalMatches > 0 ?
            (totalGoals / totalMatches).toFixed(2) : 0;

            statsMisc.innerHTML = `
                <p>Total Matches Played: <span class="font-semibold">${totalMatches}</span></p>
                <p>Total Goals Scored: <span class="font-semibold">${totalGoals}</span></p>
                <p>Average Goals Per Match: <span class="font-semibold">${avgGoals}</span></p>
            `;
        };
        
        // --- REALTIME DATABASE LISTENER ---

        const setupRealtimeListener = () => {
            tournamentRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                // CRITICAL FIX: Update the global tournamentData first
        
         tournamentData = data;
                
                if (data) {
                    // Calculations are done on the client side based on the latest data
                    const standings = 
 calculateStandings(data.teams, 
 data.schedule);
                    
                    // Render public tabs
                    renderFixtures(data);
                    renderPointsTable(standings, data.players);
              
     
                    // Render Admin Panel Status (if logged in or if admin tab is active)
                    if (isAdmin || currentTab === 'admin') {
                         renderAdminManagementPanel(data);
         
         }
                    
                    // Only re-render stats if the stats tab is active
                    if (currentTab === 'stats') {
               
      renderStats(standings, data.players);
 }
                } else {
                    // Handle case where database is empty (tournament deleted)
                    
                    renderFixtures(null);
                    renderPointsTable([]);
                    
                    if (isAdmin || currentTab === 'admin') {
                         renderAdminManagementPanel(null);
                        // Show 'No Active Tournament'
                    }
                    if (currentTab === 'stats') {
                        renderStats([]);
                    }
                }
            }, (error) => {
                console.error("Realtime database error:", error);
                alert("Could not connect to the database. Check console.");
            });
        };
        // --- START APP ---
        initializeApp();
        setupRealtimeListener();

    </script>
</body>
</html>
